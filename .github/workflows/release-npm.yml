name: Build and Release (NPM)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Debug environment
      run: |
        echo "Node.js version: $(node --version)"
        echo "npm version: $(npm --version)"
        echo "Current directory: $(pwd)"
        ls -la
        
    - name: Install dependencies with npm
      run: |
        rm -rf node_modules package-lock.json yarn.lock
        npm install
        
    - name: Build Chrome extension
      run: npm run build
      
    - name: Build Firefox extension
      run: npm run build:firefox
      
    - name: Create Chrome zip
      run: npm run zip
      
    - name: Create Firefox zip
      run: npm run zip:firefox
      
    - name: Get package version
      id: package-version
      run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
      
    - name: List zip files
      run: |
        echo "Extension files:"
        ls -la dist/
        echo "Looking for zip files:"
        find dist -name "*.zip" -type f
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.package-versiondists.version }}-npm
        name: Release v${{ steps.package-versiondists.version }} (NPM Build)
        body: |
          ## ğŸš€ Bili UP Extension v${{ steps.package-versiondists.version }}
          
          **This is a manual NPM build release**
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - ğŸ¬ æ”¯æŒ YouTube å’Œ Bilibili è§†é¢‘ä¿¡æ¯ä¿å­˜
          - ğŸ“ è‡ªåŠ¨è·å–è§†é¢‘å­—å¹•å’Œå…ƒæ•°æ®
          - ğŸ”„ å®æ—¶åŒæ­¥åˆ°åç«¯æœåŠ¡
          - ğŸ¯ æ™ºèƒ½è§†é¢‘æ£€æµ‹å’Œå¤„ç†
          
          ### ğŸ“¦ å®‰è£…åŒ…è¯´æ˜
          - **Chrome ç‰ˆæœ¬**: å…¼å®¹ Chromium å†…æ ¸æµè§ˆå™¨ (Chrome, Edge, ç­‰)
          - **Firefox ç‰ˆæœ¬**: ä¸“ä¸º Firefox æµè§ˆå™¨ä¼˜åŒ–
          
        draft: false
        prerelease: true
        files: |
          dist/*.zip
        fail_on_unmatched_files: false