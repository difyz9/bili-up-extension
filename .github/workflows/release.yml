name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'
        
    - name: Install dependencies
      run: yarn install --frozen-lockfile
      
    - name: Build Chrome extension
      run: yarn build
      
    - name: Build Firefox extension
      run: yarn build:firefox
      
    - name: Create Chrome zip
      run: yarn zip
      
    - name: Create Firefox zip
      run: yarn zip:firefox
      
    - name: Get package version
      id: package-version
      run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
      
    - name: List zip files
      run: |
        echo "Extension files:"
        ls -la .output/
        echo "Looking for zip files:"
        find .output -name "*.zip" -type f
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          ## ğŸš€ Bili UP Extension ${{ github.ref_name }}
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - ğŸ¬ æ”¯æŒ YouTube å’Œ Bilibili è§†é¢‘ä¿¡æ¯ä¿å­˜
          - ğŸ“ è‡ªåŠ¨è·å–è§†é¢‘å­—å¹•å’Œå…ƒæ•°æ®
          - ğŸ”„ å®æ—¶åŒæ­¥åˆ°åç«¯æœåŠ¡
          - ğŸ¯ æ™ºèƒ½è§†é¢‘æ£€æµ‹å’Œå¤„ç†
          
          ### ğŸ“¦ å®‰è£…åŒ…è¯´æ˜
          - **Chrome ç‰ˆæœ¬**: å…¼å®¹ Chromium å†…æ ¸æµè§ˆå™¨ (Chrome, Edge, ç­‰)
          - **Firefox ç‰ˆæœ¬**: ä¸“ä¸º Firefox æµè§ˆå™¨ä¼˜åŒ–
          
          ### ğŸ›  å®‰è£…æ–¹æ³•
          
          #### Chrome/Edge å®‰è£…
          1. ä¸‹è½½ `bili-up-extension-*-chrome.zip`
          2. è§£å‹ç¼©æ–‡ä»¶
          3. æ‰“å¼€æµè§ˆå™¨æ‰©å±•ç®¡ç†é¡µé¢
          4. å¯ç”¨"å¼€å‘è€…æ¨¡å¼"
          5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"ï¼Œé€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
          
          #### Firefox å®‰è£…
          1. ä¸‹è½½ `bili-up-extension-*-firefox.zip`
          2. æ‰“å¼€ Firefoxï¼Œè®¿é—® `about:debugging`
          3. ç‚¹å‡»"æ­¤ Firefox"
          4. ç‚¹å‡»"ä¸´æ—¶è½½å…¥é™„åŠ ç»„ä»¶"
          5. é€‰æ‹©ä¸‹è½½çš„ zip æ–‡ä»¶
          
          ### ğŸ“‹ æ›´æ–°æ—¥å¿—
          - ç‰ˆæœ¬å·: v${{ steps.package-version.outputs.version }}
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          
        draft: false
        prerelease: false
        files: |
          .output/youtube-video-sender-${{ steps.package-version.outputs.version }}-chrome.zip
          .output/youtube-video-sender-${{ steps.package-version.outputs.version }}-firefox.zip
        fail_on_unmatched_files: true